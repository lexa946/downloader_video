{% extends 'main/base.html' %}

{% block title %}Админка — Redis пользователи{% endblock %}

{% block head %}
  <link rel="stylesheet" href="/static/css/admin.css">
  <script>
    function timeAgoTs(ts){
      if(!ts) return '-';
      const d = new Date(ts * 1000);
      const now = new Date();
      const diff = Math.floor((now - d)/1000);
      if(diff < 60) return diff + ' сек назад';
      if(diff < 3600) return Math.floor(diff/60) + ' мин назад';
      if(diff < 86400) return Math.floor(diff/3600) + ' ч назад';
      return Math.floor(diff/86400) + ' д назад';
    }
    function applyAgo(){
      document.querySelectorAll('.js-relative-ago').forEach(el=>{ el.textContent = timeAgoTs(parseFloat(el.getAttribute('data-ts'))); });
    }
    document.addEventListener('DOMContentLoaded', applyAgo);

    // Excel-like filters
    document.addEventListener('DOMContentLoaded', function(){
      function closeAll(){
        document.querySelectorAll('.filter-popover.active').forEach(p=>p.classList.remove('active'));
        document.querySelectorAll('th.filter-open').forEach(th=>th.classList.remove('filter-open'));
      }
      document.querySelectorAll('.filter-icon').forEach(btn=>{
        btn.addEventListener('click', function(e){
          e.stopPropagation();
          const type = this.getAttribute('data-filter');
          const pop = document.querySelector(`.filter-popover[data-popover="${type}"]`);
          const th = this.closest('th');
          if(!pop) return;
          const isOpen = pop.classList.contains('active');
          closeAll();
          if(!isOpen) { pop.classList.add('active'); if(th) th.classList.add('filter-open'); }
        });
      });
      document.addEventListener('click', function(){ closeAll(); });

      // Immediate apply for radio options
      document.querySelectorAll('.filter-popover[data-popover="active"] input[name="active"]').forEach(r=>{
        r.addEventListener('change', function(){
          const params = new URLSearchParams(window.location.search);
          if(this.value === '') params.delete('active'); else params.set('active', this.value);
          window.location.search = params.toString();
        });
      });

      // presets
      document.querySelectorAll('.filter-popover[data-popover="last_hours"] .preset').forEach(btn=>{
        btn.addEventListener('click', function(){
          const v = this.getAttribute('data-value');
          const input = document.querySelector('.filter-popover[data-popover="last_hours"] .filter-input');
          if(input) input.value = v;
          const params = new URLSearchParams(window.location.search);
          if(v === '' || v === null) params.delete('last_hours'); else params.set('last_hours', v);
          window.location.search = params.toString();
        });
      });

      // last_hours apply on input change
      const hoursInput = document.querySelector('.filter-popover[data-popover="last_hours"] .filter-input');
      if(hoursInput){
        hoursInput.addEventListener('change', function(){
          const params = new URLSearchParams(window.location.search);
          if(this.value === '') params.delete('last_hours'); else params.set('last_hours', this.value);
          window.location.search = params.toString();
        });
      }

      // Clear buttons
      document.querySelectorAll('.filter-clear').forEach(btn=>{
        btn.addEventListener('click', function(e){
          e.stopPropagation();
          const key = this.getAttribute('data-clear');
          const params = new URLSearchParams(window.location.search);
          params.delete(key);
          window.location.search = params.toString();
        });
      });

      // Sort triggers
      document.querySelectorAll('.sort-trigger').forEach(btn=>{
        btn.addEventListener('click', function(e){
          e.stopPropagation();
          const key = this.getAttribute('data-sort');
          const params = new URLSearchParams(window.location.search);
          const currentKey = '{{ sort_key or "" }}';
          const currentDir = '{{ sort_dir or "" }}';
          let dir = 'desc';
          if(currentKey === key){
            dir = currentDir === 'desc' ? 'asc' : 'desc';
          }
          params.set('sort', key);
          params.set('dir', dir);
          window.location.search = params.toString();
        });
      });
    });
  </script>
{% endblock %}

{% block content %}
<div class="main">
  <div class="container">
    <div class="admin-toolbar">
      <h1 class="admin-title">Redis — Пользователи</h1>
      <div class="actions" style="gap:12px; align-items: center;">
        <span class="status-pill status-published">Строк: {{ rows_count }}</span>
      </div>
    </div>
    <table class="table">
      <thead>
        <tr>
          <th style="position:relative;"><span class="th-inner"><span class="th-text">User ID</span>
            <button class="filter-icon sort-trigger" data-sort="user" title="Сортировка">
              <svg viewBox="0 0 24 24"><path d="M7 10l5-5 5 5H7zm10 4l-5 5-5-5h10z"/></svg>
            </button></span>
          </th>
          <th style="position:relative;"><span class="th-inner"><span class="th-text">Активная загрузка</span>
            <button class="filter-icon" data-filter="active" title="Фильтр">
              <svg viewBox="0 0 24 24"><path d="M3 5h18l-7 8v6l-4-2v-4z"/></svg>
            </button>
            {% if filter_active is not none %}
            <button class="filter-clear" data-clear="active" title="Сбросить">
              <svg viewBox="0 0 24 24"><path d="M18.3 5.71 12 12.01l6.3 6.29-1.41 1.41L10.59 13.4 4.3 19.71 2.89 18.3 9.18 12 2.89 5.71 4.3 4.3l6.29 6.29 6.3-6.29z"/></svg>
            </button>
            {% endif %}</span>
            <div class="filter-popover" data-popover="active">
              <div class="filter-header">Фильтр по активности</div>
              <div class="filter-body">
                <label class="filter-option"><input type="radio" name="active" value="" {% if filter_active is none %}checked{% endif %}/> Все</label>
                <label class="filter-option"><input type="radio" name="active" value="1" {% if filter_active==1 %}checked{% endif %}/> Только активные</label>
                <label class="filter-option"><input type="radio" name="active" value="0" {% if filter_active==0 %}checked{% endif %}/> Только неактивные</label>
              </div>
            </div>
          </th>
          <th style="position:relative;"><span class="th-inner"><span class="th-text">Последняя активность</span>
            <button class="filter-icon" data-filter="last_hours" title="Фильтр">
              <svg viewBox="0 0 24 24"><path d="M3 5h18l-7 8v6l-4-2v-4z"/></svg>
            </button>
            <button class="filter-icon sort-trigger" data-sort="last" title="Сортировка">
              <svg viewBox="0 0 24 24"><path d="M7 10l5-5 5 5H7zm10 4l-5 5-5-5h10z"/></svg>
            </button></span>
            {% if filter_last_hours %}
            <button class="filter-clear" data-clear="last_hours" title="Сбросить">
              <svg viewBox="0 0 24 24"><path d="M18.3 5.71 12 12.01l6.3 6.29-1.41 1.41L10.59 13.4 4.3 19.71 2.89 18.3 9.18 12 2.89 5.71 4.3 4.3l6.29 6.29 6.3-6.29z"/></svg>
            </button>
            {% endif %}
            <div class="filter-popover" data-popover="last_hours">
              <div class="filter-header">Активность за последние N часов</div>
              <div class="filter-body">
                <div style="display:flex; gap:8px; align-items:center;">
                  <input type="number" min="0" step="1" class="filter-input" data-name="last_hours" value="{{ filter_last_hours or '' }}" placeholder="Часы" style="width:100px;"/>
                  <div class="filter-presets">
                    <button type="button" class="preset" data-value="1">1ч</button>
                    <button type="button" class="preset" data-value="6">6ч</button>
                    <button type="button" class="preset" data-value="24">24ч</button>
                  </div>
                </div>
              </div>
            </div>
          </th>
          <th></th>
        </tr>
      </thead>
      <tbody>
        {% for r in rows %}
        <tr>
          <td>{{ r.user_id }}</td>
          <td>
            {% if r.active_task %}
              <span class="status-pill status-published">да</span>
            {% else %}
              <span class="status-pill status-draft">нет</span>
            {% endif %}
          </td>
          <td>
            {% if r.active_task %}
              <span class="status-pill status-published">active</span>
            {% else %}
              {% if r.last_activity_ts %}
                <span class="status-pill status-archived"><span class="js-relative-ago" data-ts="{{ r.last_activity_ts }}"></span></span>
              {% else %}
                <span class="status-pill status-archived">-</span>
              {% endif %}
            {% endif %}
          </td>
          <td class="actions">
            <a class="icon-btn" href="/admin/redis/users/{{ r.user_id }}" title="Открыть карточку" aria-label="Открыть">
              <svg viewBox="0 0 24 24"><path d="M19 19H5V5h7V3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.11 0 2-.9 2-2v-7h-2v7zM14 3v2h3.59l-9.83 9.83 1.41 1.41L19 6.41V10h2V3h-7z"/></svg>
            </a>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>
{% endblock %}
